<!DOCTYPE html>
<html lang="en">
<head>
    <title>Insert HI3 UID</title>

    <script>
        function getBrowserType() {
            const test = regexp => {
                return regexp.test(navigator.userAgent);
            };

            console.log(navigator.userAgent);

            if (test(/opr\//i) || !!window.opr) {
                return 'Opera';
            } else if (test(/edg/i)) {
                return 'Microsoft Edge';
            } else if (test(/chrome|chromium|crios/i)) {
                return 'Google Chrome';
            } else if (test(/firefox|fxios/i)) {
                return 'Firefox';
            } else if (test(/safari/i)) {
                return 'Safari';
            } else if (test(/trident/i)) {
                return 'Internet Explorer';
            } else if (test(/ucbrowser/i)) {
                return 'UC Browser';
            } else if (test(/samsungbrowser/i)) {
                return 'Samsung Browser';
            } else {
                return null;
            }
        }

        const type = getBrowserType();

        // discord requires a certain user agent
        Object.defineProperty(navigator, 'userAgent', {
            get: function () { return 'DiscordBot (https://github.com/der_fruhling/, 0.1.0)'; }
        });
    </script>

    <style>
        body {
            font-family: sans-serif;
        }

        #privacy-notice {
            border: gray 3px solid;
            padding: 15px;
            margin: 15px;
            max-width: 600px;
        }

        input, button {
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div id="privacy-notice">
        <b>Privacy concerns & other info</b>

        <p>You must authenticate with Discord to use this service. This token will only be usable to set your role connections, nothing else.</p>

        <p>Due to Discord limitations, this webpage will send it's assigned token to the server to complete the request. Your token is never stored on the server and will be removed from your browser automatically in the following cases:</p>

        <ul>
            <li>The request is completed successfully.</li>
            <li>An unhandled error interacting with Discord occurs. (usually invalid token errors)</li>
        </ul>

        <p>Your token is NOT automatically removed from your browser in the following cases:</p>
        <ul>
            <li>You input an invalid username or UID.</li>
        </ul>

        <p>If you wish to remove this token, <a id="clear-cookies-link" href="https://duckduckgo.com/?q=how+to+clear+site+cookies">clear this sites cookies</a>.</p>

        <p>If you are having issues, please send an email to <a href="mailto:oml47hc14@mozmail.com">oml47hc14@mozmail.com</a> to reach me.</p>

        <a href="javascript:document.getElementById('privacy-notice').remove()">
            Close this message
        </a>

        <script>
            if(type) {
                document.getElementById('clear-cookies-link').href += '+' + encodeURIComponent(type.toLowerCase()).replaceAll('%20', '+')
            }
        </script>
    </div>

    <p id="status">Enter your Honkai Impact 3rd UID and username below to get your role!</p>

    <a href="https://discord.com/oauth2/authorize?client_id=1203211791807545455&response_type=code&redirect_uri=https%3A%2F%2Fus-west1-steam-talent-413205.cloudfunctions.net%2Fhi3-validate-linked-roles&scope=role_connections.write" id="auth-button">
        Click here to login to your Discord account.
    </a>

    <script>
        let uidValid = false;
        let usernameValid = false;

        function onAnyChange() {
            if(loggedIn && uidValid && usernameValid) {
                document.getElementById('submit').removeAttribute('disabled');
            } else if(!document.getElementById('submit').hasAttribute('disabled')) {
                document.getElementById('submit').setAttribute('disabled', '');
            }
        }

        function onUIDChange() {
            const value = document.getElementById('uid').value;
            uidValid = value.matchAll(/^[0-9]{1,10}$/g);
            onAnyChange();
        }

        function onUsernameChange() {
            const value = document.getElementById('username').value;
            usernameValid = value.length < 16 && value.length > 0;
            onAnyChange();
        }
    </script>

    <form method="post">
        <label><input type="text" name="uid" id="uid" placeholder="Honkai Impact 3rd UID" onkeyup="onUIDChange()"></label><br>
        <label><input type="text" name="username" id="username" placeholder="In-game Username" onkeyup="onUsernameChange()"></label><br>
        <button type="submit" disabled id="submit">Submit</button>
    </form>

    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        const loggedIn = !!getCookie("dstk");

        if(loggedIn) {
            document.getElementById('auth-button').textContent = 'Logged in. Click here to log in again.';
        }
    </script>
</body>
</html>